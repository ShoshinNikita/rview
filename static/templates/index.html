<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Rview â€¢ {{ .PageName }}</title>

	<link rel="stylesheet" href="/static/styles/common.css">

	<!-- Header -->
	<style>
		.header {
			display: flex;
			background-color: rgba(250, 250, 250, 0.9);
			backdrop-filter: blur(7px);
			border-radius: 3px;
			box-shadow: 0px 3px 5px 0px rgba(0, 0, 0, 0.3);
			justify-content: space-between;
			margin: 0 7px 10px;
			padding: 10px 20px;
			position: sticky;
			top: 3px;
			z-index: 2;
		}

		.breadcrumbs {
			font-size: 20px;
			margin: 0;
			padding: 0;
		}

		/* backdrop-filter is disabled in Firefox by default. As a temporary solution, increase opacity */
		@supports (-moz-appearance:none) {
			.header {
				background-color: rgba(250, 250, 250, 0.97);
			}
		}

		.breadcrumb {
			display: inline;
		}

		.breadcrumb+.breadcrumb:before {
			content: "/";
			padding: 5px;
		}

		.breadcrumb:last-of-type .breadcrumb-link {
			color: black;
			pointer-events: none;
		}

		.sort-menu {
			font-size: 18px;
		}

		.sort {
			padding-right: 5px;
		}

		.sort:last-of-type {
			padding: 0;
		}

		.sort.chosen.asc::after,
		.sort.chosen.desc::after {
			background-image: url("/static/icons/bar-chart.svg");
			background-size: cover;
			content: " ";
			display: inline-block;
			height: 20px;
			position: relative;
			transform: rotate(90deg);
			vertical-align: text-bottom;
			width: 20px;
		}

		.sort.chosen.desc::after {
			transform: rotate(270deg) scaleY(-1);
		}
	</style>

	<!-- Files -->
	<style>
		.files {
			column-gap: 20px;
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
			padding: 5px;
			row-gap: 20px;
		}

		.entry-wrapper {
			display: flex;
			align-items: center;
		}

		a.entry {
			border: 1px solid #00000000;
			color: black;
			display: block;
			padding: 5px;
			text-align: center;
			text-decoration: none;
			width: 100%;
		}

		.entry:hover,
		.entry:hover .icon {
			background-color: #e5f3ff;
		}

		.entry:hover {
			border: 1px solid #b2dbff;
		}

		.icon-wrapper {
			text-align: center;
			min-height: 60px;
			min-width: 100%;
			position: relative;
		}

		.thumbnail {
			box-shadow: 2px 2px 5px 0px rgba(0, 0, 0, 0.3);
			max-height: 150px;
			max-width: 90%;
		}

		.icon {
			background-color: white;
			height: 100px;
			/* Required to display pointer cursor */
			pointer-events: none;
		}

		.icon,
		.thumbnail {
			position: relative;
			z-index: 1;
		}

		.loader {
			animation: spin 1.2s linear infinite;
			border: 5px solid #f0f4f4;
			border-radius: 50%;
			border-top: 5px solid #0275d8;
			height: 50px;
			left: 50%;
			position: absolute;
			top: 50%;
			width: 50px;
		}

		@keyframes spin {
			0% {
				transform: translate(-50%, -50%) rotate(0deg);
			}

			100% {
				transform: translate(-50%, -50%) rotate(360deg);
			}
		}

		.entry-filename {
			display: inline-block;
			overflow: hidden;
			text-align: center;
			text-overflow: ellipsis;
			width: 100%;
			white-space: nowrap;
		}
	</style>

	<!-- Preview -->
	<style>
		.preview {
			height: 100%;
			overflow: hidden;
			position: fixed;
			top: 0;
			width: 100%;
			display: none;
		}

		.preview.opened {
			background-color: #000000b0;
			z-index: 3;
			display: block;
		}

		.preview-iframe {
			height: 90vh;
			left: 50%;
			position: fixed;
			top: 50%;
			transform: translate(-50%, -52%);
			width: 90vw;
		}
	</style>
</head>

<body>
	<div class="header">
		<ul class="breadcrumbs">
			{{ range .Breadcrumbs }}
			<li class="breadcrumb">
				<a href="{{ .Link }}" class="breadcrumb-link">{{ .Text }}</a>
			</li>
			{{ end }}
		</ul>

		<div class="sort-menu">
			{{ $order := "asc" }}
			{{ $oppositeOrder := "desc" }}
			{{ if eq .Order "desc" }}
			{{ $order = "desc" }}
			{{ $oppositeOrder = "asc" }}
			{{ end }}

			{{ $nameSortParams := `href="?sort=namedirfirst&order=asc" class="sort" title="Sort by name asc"` }}
			<!-- People usually want to sort files by size in the descending order. -->
			{{ $sizeSortParams := `href="?sort=size&order=desc" class="sort" title="Sort by size desc"` }}
			{{ $timeSortParams := `href="?sort=time&order=asc" class="sort" title="Sort by time asc"` }}

			{{ if eq .Sort "size" }}
			{{ $sizeSortParams = printf `href="?sort=size&order=%s" class="sort chosen %s" title="Sort by size %[1]s"` $oppositeOrder $order }}

			{{ else if eq .Sort "time"}}
			{{ $timeSortParams = printf `href="?sort=time&order=%s" class="sort chosen %s" title="Sort by time %[1]s"` $oppositeOrder $order }}

			{{ else }}
			{{ $nameSortParams = printf `href="?sort=namedirfirst&order=%s" class="sort chosen %s" title="Sort by name %[1]s"` $oppositeOrder $order }}

			{{ end }}

			<a {{ attr $nameSortParams }}>Name</a>
			<a {{ attr $sizeSortParams }}>Size</a>
			<a {{ attr $timeSortParams }}>Time</a>
		</div>
	</div>

	<div class="files">
		{{ range .Entries }}

		{{ $href := .WebDirURL }}
		{{ $target := "_self" }}
		{{ $title := .Filename }}

		{{ if not .IsDir }}
		{{ $href = .OriginalFileURL }}
		{{ $target = "_blank" }}
		{{ $title = printf "%s\n\nFile Size: %s\nMod Time: %s" .Filename .HumanReadableSize .HumanReadableModTime }}
		{{ end }}

		{{ if .ThumbnailURL }}
		{{ $href = "#" }}
		{{ $target = "" }}
		{{ end }}

		<!-- Open preview for images and download other files -->
		{{ $attrs := "" }}
		{{ if .ThumbnailURL }}
		{{ $attrs = printf `onclick="openPreview('%s')"` .Filename }}
		{{ else if not .IsDir }}
		{{ $attrs = printf `download="%s"` .Filename }}
		{{ end }}

		<div class="entry-wrapper">
			<a class="entry" href="{{ $href }}" target="{{ $target }}" title="{{ $title }}" {{ attr $attrs }}>
				<div class="icon-wrapper">
					<div class="loader"></div>

					{{ if .ThumbnailURL }}
					<img src="{{ .ThumbnailURL }}" class="thumbnail" loading="lazy">
					{{ else }}
					<object data="{{ .IconURL }}" type="image/svg+xml" class="icon" tabindex="-1"></object>
					{{ end }}
				</div>

				<span class="entry-filename">{{ .Filename }}</span>
			</a>
		</div>

		{{ end }}
	</div>

	<a class="preview" title="Close Preview" onclick="closePreview()">
		<iframe class="preview-iframe" src="" frameborder="0"></iframe>
	</a>

	<script>
		const preview = document.getElementsByClassName("preview")[0];
		const previewIframe = document.getElementsByClassName("preview-iframe")[0];

		const openPreview = (filename) => {
			preview.classList.add("opened");

			previewIframe.src = window.location.toString().
				replace("/ui/", "/preview/"). // preview url is the same except the first part.
				replace(/#.*/, "").           // remove hash
				concat("#", filename);

			// Focus for event listeners.
			previewIframe.focus();
		};

		const closePreview = () => {
			preview.classList.remove("opened");
		};

		window.addEventListener("message", (ev) => {
			if (ev.data.name === "close-preview") {
				closePreview();
			}
		});
	</script>
</body>

</html>